# Blackhole Node Plugin Manifest (Mesh-Compliant Version)
name: node
version: 1.0.0
api_version: v1
description: "P2P networking, node management, and distributed communication plugin"
author: "Blackhole Foundation"
license: MIT
homepage: https://github.com/blackhole/core/pkg/plugins/node
repository: https://github.com/blackhole/core

# Plugin classification
type: service
architecture:
  - darwin-amd64
  - darwin-arm64
  - linux-amd64
  - linux-arm64

# Binary configuration
binary:
  name: node-mesh
  main: ./

# Mesh communication configuration
mesh:
  enabled: true
  service_name: node
  endpoint: "localhost:0"  # Dynamic port allocation
  subscribe_patterns:
    - "storage.content.*"     # Storage events
    - "identity.peer.*"       # Identity events
    - "mesh.topology.*"       # Mesh topology changes
  publish_patterns:
    - "node.peer.*"          # Peer events
    - "node.network.*"       # Network status events
    - "node.started"         # Service lifecycle
    - "node.stopped"         # Service lifecycle

# gRPC service configuration
grpc:
  service: blackhole.node.v1.NodePlugin
  reflection: true
  health_check: true

# Resource requirements
resources:
  min_memory: 256M
  max_memory: 1G
  min_cpu: 0.2
  max_cpu: 2.0
  disk_space: 500M
  network_bandwidth: 10M  # Minimum network bandwidth

# Plugin dependencies
dependencies:
  core: ">=1.0.0"
  plugins:
    - name: mesh-router
      version: ">=1.0.0"
      optional: false
      description: "Required for mesh communication"
    - name: identity
      version: ">=1.0.0"
      optional: false
      description: "Required for peer authentication"

# Security capabilities
capabilities:
  - network           # Full network access for P2P
  - filesystem:read   # Read configuration files
  - filesystem:write  # Write peer data and state
  - mesh:publish      # Publish to mesh topics
  - mesh:subscribe    # Subscribe to mesh topics
  - process:spawn     # May spawn helper processes

# Health check configuration
health:
  interval: 30s
  timeout: 5s
  retries: 3
  startup_delay: 10s  # Wait before first check

# Metrics exposed
metrics:
  - name: peers_connected
    type: gauge
    description: "Number of connected peers"
  - name: messages_sent
    type: counter
    description: "Total messages sent"
  - name: messages_received
    type: counter
    description: "Total messages received"
  - name: bandwidth_in
    type: gauge
    description: "Incoming bandwidth usage"
  - name: bandwidth_out
    type: gauge
    description: "Outgoing bandwidth usage"
  - name: mesh_events_published
    type: counter
    description: "Number of events published to mesh"
  - name: mesh_events_received
    type: counter
    description: "Number of events received from mesh"

# Configuration schema
config_schema:
  type: object
  required: ["p2p", "mesh"]
  properties:
    mesh:
      type: object
      required: ["router_address"]
      properties:
        router_address:
          type: string
          default: "localhost:50000"
          description: "Mesh router address"
        
        retry_interval:
          type: string
          default: "5s"
          description: "Mesh connection retry interval"
        
        max_retries:
          type: integer
          default: 10
          description: "Maximum connection retries"
    
    p2p:
      type: object
      required: ["listen_addresses"]
      properties:
        listen_addresses:
          type: array
          items:
            type: string
          default: ["/ip4/0.0.0.0/tcp/0", "/ip6/::/tcp/0"]
          description: "P2P listen addresses"
        
        bootstrap_peers:
          type: array
          items:
            type: string
          description: "Bootstrap peer multiaddresses"
        
        max_connections:
          type: integer
          default: 100
          minimum: 10
          maximum: 1000
          description: "Maximum peer connections"
        
        enable_relay:
          type: boolean
          default: true
          description: "Enable relay functionality"
        
        enable_nat:
          type: boolean
          default: true
          description: "Enable NAT traversal"
    
    discovery:
      type: object
      properties:
        mdns:
          type: object
          properties:
            enabled:
              type: boolean
              default: true
              description: "Enable mDNS discovery"
            
            interval:
              type: string
              default: "1m"
              description: "mDNS discovery interval"
        
        dht:
          type: object
          properties:
            enabled:
              type: boolean
              default: true
              description: "Enable DHT"
            
            mode:
              type: string
              enum: ["client", "server", "auto"]
              default: "auto"
              description: "DHT operation mode"
    
    storage:
      type: object
      properties:
        path:
          type: string
          default: "~/.blackhole/node/data"
          description: "Data storage path"
        
        max_size:
          type: string
          default: "1GB"
          description: "Maximum storage size"

# Plugin features
features:
  - p2p-networking
  - peer-discovery
  - message-routing
  - nat-traversal
  - relay-service
  - distributed-hash-table
  - pubsub-messaging
  - peer-reputation
  - mesh-communication
  - event-driven-architecture

# Supported protocols
protocols:
  - /blackhole/1.0.0
  - /ipfs/kad/1.0.0
  - /libp2p/circuit/relay/0.2.0
  - /libp2p/autonat/1.0.0
  - /meshsub/1.1.0
  - /grpc/1.0.0

# Plugin tags for marketplace
tags:
  - networking
  - p2p
  - distributed
  - communication
  - mesh
  - event-driven